# 主从同步(复制)





## 概述

在 Redis 中，用户可以通过执行 SLAVEOF 命令或者设置 slaveof 选项，让一个服务器去复制(replicate)另一个服务器，我们称呼被复制的服务器为主服务器（master），而对主服务器进行复制的服务器则被称为从服务器（slave）



## 原版复制功能

两步走:

- 同步命令sync,bgsave生成RDB文件,然后发送RDB文件
- 发送缓冲区中此期间发生的所有的写命令

![image-20190819133559421](assets/主从同步/image-20190819133559421.png)





- 初次复制：从服务器以前没有复制过任何主服务器，或者从服务器当前要复制的主服务器和上一次复制的主服务器不同。

- 断线后重复制：处于命令传播阶段的主从服务器因为网络原因而中断了复制，但从服务器通过自动重连接重新连上了主服务器，并继续复制主服务器。

对于初次复制来说，旧版复制功能能够很好地完成任务，但对于断线后重复制来说，旧版复制功能会重新走一遍流程,发送RDB文件,十分低效.

## PSYNC

PSYNC命令具有**完整重同步**（full resynchronization)和**部分重同步**（partial resynchronization)两种模式：

- 完整重同步用于处理初次复制情况，**完整重同步的执行步骤和SYNC命令的执行步骤基本一样**,它们都是通过让主服务器创建并发送RDB文件，以及向从服务器发送保存在缓冲区里面的写命令来进行同步。

 - 部分重同步则用于处理断线后重复制情况：当从服务器在断线后重新连接主服务器时，如果条件允许，主服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接收并执行这些写命令，就可以将数据库更新至主服务器当前所处的状态。

     ![1565968600068](assets/主从同步/1565968600068.png)







## 部分重同步的实现



### 主服务器的复制偏移量（replication offset)和从服务器的复制偏移量

执行复制的主从服务器都会维护一个偏移量,主服务器发送了N个字节偏移量就加N,从服务器接受了N个字节偏移量也加N.



通过对比主从服务器的复制偏移量，程序可以很容易地知道主从服务器是否处于一致状态 

- 如果主从服务器处于一致状态，那么主从服务器两者的偏移量总是相同的。
- 相反，如果主从服务器两者的偏移量并不相同，那么说明主从服务器并未处于一致状态。



### 主服务器的复制积压缓冲区

复制积压缓冲区会被保存最近传播给从服务器的写命令,默认1MB.

公式: second * write_size_per_ second 

 second :从服务器断开后重新连接上主服务器所需的平均时间（以秒计算）

 write_size_per_ second 则是主服务器平均每秒产生的写命令数据量（协议格式的写命令的长度总和）。

如果主服务器平均每秒产生 1 MB 的写数据，而从服务器断线之后平均要 5 秒才能重新连接上主服务器，那么复制积压缓冲区的大小就不能低于 5 MB。



- 如果。offset 偏移量之后的数据（也即是偏移量。offset+1 开始的数据）仍然存在于复制积压缓冲区里面，那么主服务器将对从服务器执行部分重同步操作。-
- 相反，如果 offset 偏移量之后的数据已经不存在于复制积压缓冲区，那么主服务器将对从服务器执行完整重同步操作。





### 服务器的运行ID（Run ID）

每个 Redis 服务器，不论主服务器还是从服务，都会有自已的运行 D。

运行 ID 在服务器启动时自动生成，由 40 个随机的十六进制字符组成，例如·`53b9b28df8042fdc9 ab5e3fcbbbabff1d5dce2b3 `



当从服务器断线重连,他会查看上次同步的主服务器id和当前主服务器id是否一致.







## 心跳检测

在命令传播阶段，从服务器默认会以每秒一次的频率，向主服务器发送命令

REPLCONE ACK  <replication offset>

其中 replication offset 是从服务器当前的复制偏移量。发送 REPLCONFACK 命令对于主从服务器有三个作用

- 检测主从服务器的网络连接状态。

  主服务器会记录slave-ip-port-lag.

  lag是相应的从服务器最后一次向主服务器发送 REPLCONF ACK 命令距离现在过了多少秒

- 辅助实现 min- slaves 选项

  Redis 的 min-slaves-to- write 和 min-slaves-max-lag 两个选项可以防止主服务器在不安全的情况下执行写命令。

  举个例子，如果我们向主服务器提供以下设置

  min-slaves-to-write 3

  min-slaves-max-lag 10

  那么在从服务器的数量少于 3 个，或者三个从服务器的延迟（lag）值都大于或等于 10 秒时，主服务器将拒绝执行写命令，这里的延迟值就是上面提到的 NFO replication 命令的 1ag 值。

- 检测命令丢失(偏移量)。























